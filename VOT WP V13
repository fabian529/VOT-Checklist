<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOT Protokoll (V25 Large Photos)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f5f5f7; color: #1d1d1f; }
        
        .input-group:focus-within label { transform: translateY(-22px) scale(0.85); color: #0071e3; }
        .input-filled label { transform: translateY(-22px) scale(0.85); }
        .progress-fill { transition: width 0.5s ease-out; }

        /* --- PRINT STYLES --- */
        @media print {
            @page { margin: 15mm; size: A4; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            
            /* HIDE UI ELEMENTS */
            .no-print, nav, aside, button, .sidebar, .bottom-bar { display: none !important; }
            
            /* SHOW PRINT VIEW */
            #print-view {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            /* Allow breaks inside main container but manage elements */
            .pdf-section { page-break-inside: auto !important; break-inside: auto !important; }
            .pdf-grid { page-break-inside: avoid; break-inside: avoid; }
            .pdf-img-container { page-break-inside: avoid; break-inside: avoid; }
            
            /* COLOR FIXES */
            h1, h2, h3, .pdf-label { color: #000 !important; }
            .pdf-header { border-bottom-color: #0071e3 !important; }
        }

        /* --- PDF LAYOUT (SCREEN PREVIEW) --- */
        #print-view { display: none; } /* Hidden in Edit Mode */
        
        .preview-mode #print-view {
            display: block;
            margin: 20px auto;
            max-width: 210mm;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            border-radius: 8px;
        }

        /* PDF Typography */
        .pdf-header { border-bottom: 2px solid #0071e3; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .pdf-title { font-size: 24pt; font-weight: 800; color: #1d1d1f; line-height: 1; }
        .pdf-subtitle { font-size: 10pt; color: #86868b; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        .pdf-meta { text-align: right; font-size: 10pt; color: #1d1d1f; }
        
        /* Section logic: Allow break inside section, but avoid breaking title from content */
        .pdf-section { margin-bottom: 40px; }
        .pdf-section-title { font-size: 14pt; font-weight: 700; color: #1d1d1f; border-bottom: 1px solid #e5e5e5; padding-bottom: 8px; margin-bottom: 20px; page-break-after: avoid; }
        
        /* Data Grid: Keep together if possible */
        .pdf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 40px; margin-bottom: 20px; break-inside: avoid; page-break-inside: avoid; }
        .pdf-field { margin-bottom: 5px; }
        .pdf-label { font-size: 8pt; color: #86868b; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .pdf-value { font-size: 11pt; color: #1d1d1f; font-weight: 500; border-bottom: 1px dotted #e5e5e5; padding-bottom: 2px; }
        .pdf-full-width { grid-column: span 2; }

        /* --- BIG PHOTO STYLES --- */
        .pdf-photos { margin-top: 25px; width: 100%; }
        .pdf-photo-title { 
            font-size: 10pt; font-weight: 700; color: #1d1d1f; 
            margin-bottom: 10px; border-left: 4px solid #0071e3; padding-left: 10px; 
            text-transform: uppercase; 
            page-break-after: avoid; 
        }
        
        /* Vertical Stack for Max Size */
        .pdf-photo-list { display: flex; flex-direction: column; gap: 20px; width: 100%; }
        
        .pdf-img-container { 
            width: 100%;
            break-inside: avoid;
            page-break-inside: avoid; /* DON'T CUT IMAGES IN HALF */
            background: #fff;
            border: 1px solid #e5e5e5;
            padding: 5px;
            border-radius: 4px;
        }
        
        .pdf-img { 
            width: 100%; 
            height: auto; /* Maintain Aspect Ratio */
            max-height: 950px; /* Max height approx one A4 page to prevent overflow issues */
            object-fit: contain; 
            display: block;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- ICONS ---
    const Icon = ({ path, size = 18, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html: path}} />
    );

    const icons = {
        user: '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>',
        home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>',
        camera: '<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle>',
        trash: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>',
        plus: '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>',
        print: '<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect>',
        edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>',
        check: '<polyline points="20 6 9 17 4 12"></polyline>',
        zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>',
        thermometer: '<path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path>',
        ruler: '<path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"></path>',
        truck: '<rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle>',
        settings: '<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>',
        chart: '<line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line>',
        json: '<polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline>'
    };

    // --- PHOTO MANAGER ---
    const PhotoManager = ({ id, label, photos, setPhotos }) => {
        const fileInputRef = useRef(null);
        const currentPhotos = photos[id] || [];
        const handleFileChange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => setPhotos(prev => ({ ...prev, [id]: [...(prev[id] || []), reader.result] }));
                    reader.readAsDataURL(file);
                });
            }
            e.target.value = null;
        };
        const handleRemove = (index) => setPhotos(prev => ({ ...prev, [id]: prev[id].filter((_, i) => i !== index) }));

        return (
            <div className="mt-4 break-inside-avoid">
                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" multiple className="hidden" />
                <div className="flex justify-between items-end mb-2">
                    <label className="text-sm font-semibold text-[#1d1d1f]">{label}</label>
                    <span className="text-xs text-[#86868b] border px-2 py-0.5 rounded">{currentPhotos.length} Bilder</span>
                </div>
                <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
                    {currentPhotos.map((photo, index) => (
                        <div key={index} className="relative aspect-square rounded-xl overflow-hidden border border-[#d2d2d7] bg-black group">
                            <img src={photo} className="w-full h-full object-cover" />
                            <button onClick={() => handleRemove(index)} className="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow hover:bg-red-600 z-10"><Icon path={icons.trash} size={12} /></button>
                        </div>
                    ))}
                    <div onClick={() => fileInputRef.current.click()} className="aspect-square rounded-xl border-2 border-dashed border-[#d2d2d7] bg-[#fbfbfd] hover:bg-[#f0f8ff] hover:border-[#0071e3] cursor-pointer flex flex-col items-center justify-center gap-1 transition-all">
                        <Icon path={icons.plus} size={24} className="text-[#0071e3]" />
                        <span className="text-[10px] font-medium text-[#86868b]">Hinzufügen</span>
                    </div>
                </div>
            </div>
        );
    };

    // --- FORM COMPONENTS ---
    const Section = ({ id, icon, title, children }) => (
        <section id={id} className="bg-white p-6 rounded-2xl shadow-sm border border-[#d2d2d7] mb-8 animate-in break-inside-avoid scroll-mt-24">
            <div className="flex items-center gap-3 mb-6 border-b border-[#f5f5f7] pb-4">
                <div className="w-8 h-8 rounded-full bg-[#f5f5f7] flex items-center justify-center text-[#1d1d1f]"><Icon path={icon} size={16} /></div>
                <h2 className="text-[17px] font-semibold text-[#1d1d1f]">{title}</h2>
            </div>
            <div className="space-y-6">{children}</div>
        </section>
    );

    const TextInput = ({ label, value, onChange, width = "full", suffix, type="text" }) => (
        <div className={`bg-[#f5f5f7] rounded-xl px-4 py-2 border border-transparent focus-within:bg-white focus-within:border-[#0071e3] transition-all ${width === 'half' ? 'col-span-1' : 'col-span-2'}`}>
            <label className="block text-xs text-[#86868b] mb-1">{label}</label>
            <div className="flex items-center">
                <input type={type} value={value} onChange={onChange} className="w-full bg-transparent outline-none text-[#1d1d1f]" />
                {suffix && <span className="text-xs text-[#86868b] ml-1">{suffix}</span>}
            </div>
        </div>
    );

    const SelectInput = ({ label, value, onChange, options, width = "half" }) => (
        <div className={`bg-[#f5f5f7] rounded-xl px-4 py-2 border border-transparent focus-within:bg-white focus-within:border-[#0071e3] col-span-2 ${width === 'half' ? 'md:col-span-1' : ''}`}>
            <label className="block text-xs text-[#86868b] mb-1">{label}</label>
            <select value={value} onChange={onChange} className="w-full bg-transparent outline-none text-[#1d1d1f] cursor-pointer appearance-none">
                <option value="">Bitte wählen...</option>
                {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
            </select>
        </div>
    );

    const MultiSelect = ({ label, options, selected, onChange }) => {
        const toggle = (opt) => {
            if (selected.includes(opt)) {
                onChange(selected.filter(s => s !== opt));
            } else {
                onChange([...selected, opt]);
            }
        };

        return (
            <div className="col-span-2">
                <label className="block text-xs text-[#86868b] mb-2">{label}</label>
                <div className="flex flex-wrap gap-2">
                    {options.map(opt => (
                        <button 
                            key={opt} 
                            onClick={() => toggle(opt)}
                            className={`px-3 py-1.5 text-xs font-medium rounded-full border transition-all ${
                                selected.includes(opt) 
                                    ? 'bg-[#0071e3] text-white border-[#0071e3]' 
                                    : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'
                            }`}
                        >
                            {opt}
                        </button>
                    ))}
                </div>
            </div>
        );
    };

    const Toggle = ({ label, checked, onChange }) => (
        <div className="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
            <span className="text-sm text-[#1d1d1f]">{label}</span>
            <label className="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" className="sr-only peer" checked={checked} onChange={onChange} />
                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#34c759]"></div>
            </label>
        </div>
    );

    // --- PREVIEW LAYOUT ---
    const PreviewLayout = ({ data, photos }) => {
        const renderField = (label, value, fullWidth = false) => (
            <div className={`pdf-field ${fullWidth ? 'pdf-full-width' : ''}`}>
                <div className="pdf-label">{label}</div>
                <div className="pdf-value">{value || '-'}</div>
            </div>
        );
        const renderBool = (v) => v ? "Ja" : "Nein";
        
        const renderPhotoGrid = (id, title) => {
            const pics = photos[id] || [];
            if(pics.length === 0) return null;
            return (
                <div className="pdf-photos">
                    <div className="pdf-photo-title">{title} ({pics.length})</div>
                    <div className="pdf-photo-list">
                        {pics.map((src, i) => (
                            <div key={i} className="pdf-img-container">
                                <img src={src} className="pdf-img" />
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        // Format Water Heating for Display
        const formatWaterHeating = () => {
            if (!data.waterHeating || data.waterHeating.length === 0) return '-';
            const base = data.waterHeating.join(', ');
            if (data.waterHeating.includes('Sonstiges') && data.waterHeatingOther) {
                return `${base} (${data.waterHeatingOther})`;
            }
            return base;
        };

        return (
            <div id="print-view">
                {/* Header */}
                <div className="pdf-header">
                    <div>
                        <div className="pdf-title">VOT Protokoll</div>
                        <div className="pdf-subtitle">Mission Solar | Technische Aufnahme</div>
                    </div>
                    <div className="pdf-meta">
                        <div style={{fontWeight: 700}}>{data.firstName} {data.lastName}</div>
                        <div>{new Date().toLocaleDateString()}</div>
                    </div>
                </div>

                {/* 1. KUNDE */}
                <div className="pdf-section">
                    <div className="pdf-section-title">1. Kundendaten</div>
                    <div className="pdf-grid">
                        {renderField("Vorname", data.firstName)}
                        {renderField("Nachname", data.lastName)}
                        {renderField("Vollmacht vorhanden", renderBool(data.proxyActive))}
                    </div>
                    {data.proxyActive && renderPhotoGrid('foto_vollmacht', 'Vollmacht Dokument')}
                </div>

                {/* 2. GEBÄUDESTATUS */}
                <div className="pdf-section">
                    <div className="pdf-section-title">2. Gebäudestatus</div>
                    <div style={{marginBottom:10, fontWeight:'bold', fontSize:'10pt'}}>Bestandsheizung</div>
                    <div className="pdf-grid">
                        {renderField("System / Heizungstyp", data.heatingSystem)}
                        {renderField("Modell", data.heatingModel)}
                        {renderField("Baujahr", data.heatingYear)}
                        {renderField("Verbrauch", data.consumption)}
                        {renderField("Beheizte Fläche", data.heatedArea + " m²")}
                        {renderField("Warmwasserbereitung", formatWaterHeating(), true)}
                        
                        {/* Conditional Heat Pump Fields in PDF */}
                        {data.heatingSystem === 'Wärmepumpe' && renderField("Pufferspeicher Bestand", data.bufferTank)}
                        {data.heatingSystem === 'Wärmepumpe' && renderField("WW-Speicher Bestand", data.waterTank)}
                        {data.heatingSystem === 'Wärmepumpe' && renderField("Inneneinheit Bestand", data.indoorUnit)}
                    </div>
                    
                    <div style={{marginBottom:10, fontWeight:'bold', fontSize:'10pt', marginTop: 15}}>Wärmeverteilung</div>
                    <div className="pdf-grid">
                        {renderField("Typ", data.heatDistribution === 'Andere' ? data.heatDistributionOther : data.heatDistribution)}
                        {renderField("Heizkreise (Anzahl)", data.heatingCircuits)}
                        
                        {(data.heatDistribution.includes('Heizkörper') || data.heatDistributionOther.toLowerCase().includes('heizkörper')) && renderField("Radiatorentyp", data.radiatorType)}
                        {(data.heatDistribution.includes('Heizkörper') || data.heatDistributionOther.toLowerCase().includes('heizkörper')) && renderField("Tausch nötig?", renderBool(data.radiatorSwap))}
                    </div>
                    {renderPhotoGrid('fotos_heizung', 'Bestandsheizung & Gebäude')}
                    {renderPhotoGrid('fotos_heizkoerper', 'Heizkörper / Verteilung')}
                </div>

                {/* 3. TECHNIKRAUM */}
                <div className="pdf-section">
                    <div className="pdf-section-title">3. Technikraum</div>
                    <div className="pdf-grid">
                        {renderField("Rohrdimensionen", data.pipeDimensions)}
                        {renderField("Engste Tür", data.narrowestDoor + " cm")}
                    </div>
                    {renderPhotoGrid('fotos_platzmanagement', 'Platzmanagement Technikraum')}
                    {renderPhotoGrid('fotos_pumpengruppe', 'Bestehende Pumpengruppe')}
                    {renderPhotoGrid('fotos_heizkreisverteiler', 'Heizkreisverteiler')}
                    {renderPhotoGrid('fotos_leitungsfuehrung', 'Aktuelle Leitungsführung')}
                </div>

                {/* 4. AUSSENEINHEIT */}
                <div className="pdf-section">
                    <div className="pdf-section-title">4. Außeneinheit</div>
                    <div className="pdf-grid">
                        {renderField("Schutzbereich eingehalten", renderBool(data.protectionZoneOK))}
                        {renderField("Schallproblem?", renderBool(data.noiseProblem))}
                        {data.noiseProblem && renderField("Erklärung Schall", data.noiseProblemNotes, true)}
                        {renderField("Leitungsweg bis Eingang (m)", data.pipeLengthOuter + " m")}
                        {renderField("Wanddurchführung", data.wallBreakthroughType)}
                        {(data.wallBreakthroughType === 'Bohrung notwendig' || data.wallBreakthroughType === 'Unterirdisch mit Wanddurchführung') && renderField("Material", data.wallMaterial)}
                        {(data.wallBreakthroughType === 'Bohrung notwendig' || data.wallBreakthroughType === 'Unterirdisch mit Wanddurchführung') && renderField("Dicke", data.wallThickness + " cm")}
                        {renderField("Besonderheiten", data.outdoorNotes, true)}
                    </div>
                    {renderPhotoGrid('fotos_aufstellort', 'Aufstellort')}
                    {renderPhotoGrid('fotos_leitungsweg', 'Leitungsweg Außen')}
                    {renderPhotoGrid('fotos_wand', 'Wanddurchführung')}
                </div>

                {/* 5. ELEKTRO */}
                <div className="pdf-section">
                    <div className="pdf-section-title">5. Elektro</div>
                    <div className="pdf-grid">
                        {renderField("Hauptsicherung", data.mainFuse + " A")}
                        {renderField("Platz im Verteiler", renderBool(data.elecSpace))}
                        {renderField("Erdungsschiene Frei", renderBool(data.groundingRail))}
                        {renderField("Internet (LAN)", renderBool(data.internetLan))}
                        {renderField("Kabelweg (Innen -> Verteiler)", data.cablePathInner)}
                        {renderField("Anmerkungen", data.elecNotes, true)}
                    </div>
                    {renderPhotoGrid('fotos_verteiler', 'Elektroverteiler')}
                </div>

                {/* 6. LIEFERDETAILS */}
                <div className="pdf-section">
                    <div className="pdf-section-title">6. Lieferdetails</div>
                    <div className="pdf-grid">
                        {renderField("Ablageort", data.deliveryLocation, true)}
                        {renderField("Lieferwünsche", data.deliveryWishes, true)}
                    </div>
                    {renderPhotoGrid('fotos_ablageort', 'Ablageort')}
                </div>

                <div className="pdf-section">
                    <div className="pdf-section-title">Allgemeine Notizen</div>
                    <div style={{whiteSpace: 'pre-wrap', fontSize: '11pt'}}>{data.generalNotes}</div>
                </div>

            </div>
        );
    };

    // --- MAIN APP ---
    function App() {
        const [view, setView] = useState('input');
        
        // Initial State based on the new checklist structure
        const [data, setData] = useState({
            // 1. Kundendaten
            firstName: '', lastName: '',
            proxyActive: false,

            // 2. Gebäudestatus
            heatingSystem: '', heatingModel: '', heatingYear: '',
            consumption: '', heatedArea: '',
            heatDistribution: '', heatDistributionOther: '', 
            heatingCircuits: '', 
            waterHeating: [], waterHeatingOther: '', // CHANGED TO ARRAY for MULTI SELECT
            radiatorType: '', radiatorSwap: false,
            // Existing Equipment (only for Heat Pump)
            bufferTank: '', waterTank: '', indoorUnit: '',

            // 3. Technikraum
            pipeDimensions: '', narrowestDoor: '',

            // 4. Außeneinheit
            protectionZoneOK: true, 
            noiseProblem: false, noiseProblemNotes: '', // NEW
            pipeLengthOuter: '', 
            wallBreakthroughType: '', wallMaterial: '', wallThickness: '',
            outdoorNotes: '',

            // 5. Elektro
            mainFuse: '', elecSpace: true, groundingRail: true,
            cablePathInner: '', internetLan: true, elecNotes: '',

            // 6. Lieferdetails
            deliveryLocation: '', deliveryWishes: '',

            // Global
            generalNotes: ''
        });

        const [photos, setPhotos] = useState({});
        const [progress, setProgress] = useState(0);

        const update = (field, val) => setData(prev => ({ ...prev, [field]: val }));

        // Update progress logic
        useEffect(() => {
            const filledFields = Object.values(data).filter(val => val !== '' && val !== null && val !== false && (!Array.isArray(val) || val.length > 0)).length;
            const photoCount = Object.keys(photos).length;
            const totalFields = 30; // Approx target
            let percent = Math.min(100, Math.round((filledFields + (photoCount * 2)) / totalFields * 100));
            setProgress(percent);
        }, [data, photos]);

        const scrollToSection = (id) => {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        const handlePrint = () => {
            window.print();
        };

        const handleJsonExport = () => {
            const blob = new Blob([JSON.stringify({ ...data, photos }, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `VOT_${data.lastName}_${data.firstName}.json`;
            link.click();
        };

        const isSectionComplete = (section) => {
            if(section === 'sec-1') return data.lastName.length > 2 && data.firstName.length > 2;
            if(section === 'sec-2') return data.heatingSystem && data.consumption;
            if(section === 'sec-5') return data.mainFuse;
            return false;
        };

        const SidebarLink = ({ id, label }) => {
            const complete = isSectionComplete(id);
            return (
                <button onClick={() => scrollToSection(id)} className="flex items-center justify-between w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600 transition-colors group">
                    <span className="text-xs font-medium">{label}</span>
                    <div className={`w-2 h-2 rounded-full ${complete ? 'bg-green-500' : 'bg-red-400 opacity-50 group-hover:opacity-100'}`}></div>
                </button>
            )
        }

        return (
            <div className={`min-h-screen ${view === 'preview' ? 'preview-mode' : 'edit-mode'}`}>
                
                {view === 'preview' ? (
                    <div className="bg-gray-100 min-h-screen pb-20">
                        <div className="sticky top-0 z-50 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm no-print">
                            <button onClick={() => setView('input')} className="text-[#0071e3] font-medium flex items-center gap-1 hover:underline">
                                <Icon path={icons.edit} /> Zurück zur Bearbeitung
                            </button>
                            <div className="flex gap-4 items-center">
                                <button 
                                    onClick={handlePrint} 
                                    className="px-6 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 transition-all bg-[#0071e3] text-white hover:bg-[#005bb5]"
                                >
                                    <Icon path={icons.print} /> Drucken / PDF
                                </button>
                            </div>
                        </div>
                        <div className="py-8">
                            <PreviewLayout data={data} photos={photos} />
                        </div>
                    </div>
                ) : (
                    <div className="pb-32">
                        <nav className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-[#d2d2d7] no-print">
                            <div className="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
                                <div className="font-semibold text-lg">Mission Solar <span className="text-gray-400 text-sm">| VOT V25</span></div>
                                <div className="text-xs bg-gray-100 px-2 py-1 rounded">Large Photos</div>
                            </div>
                        </nav>

                        <main className="max-w-5xl mx-auto pt-8 px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* SIDEBAR */}
                            <div className="lg:col-span-4 hidden lg:block no-print">
                                <div className="sticky top-24 space-y-4">
                                    <div className="bg-white p-5 rounded-2xl border border-[#d2d2d7] shadow-sm">
                                        <h3 className="text-sm font-semibold uppercase tracking-wide mb-3 flex items-center gap-2">
                                            <Icon path={icons.chart} size={16} /> Fortschritt
                                        </h3>
                                        <div className="relative w-full h-4 bg-gray-200 rounded-full overflow-hidden mb-4">
                                            <div className="absolute top-0 left-0 h-full bg-[#0071e3] progress-fill" style={{width: `${progress}%`}}></div>
                                        </div>
                                        <div className="space-y-1">
                                            <SidebarLink id="sec-1" label="1. Kundendaten" />
                                            <SidebarLink id="sec-2" label="2. Gebäudestatus" />
                                            <SidebarLink id="sec-3" label="3. Technikraum" />
                                            <SidebarLink id="sec-4" label="4. Außeneinheit" />
                                            <SidebarLink id="sec-5" label="5. Elektro" />
                                            <SidebarLink id="sec-6" label="6. Lieferdetails" />
                                        </div>
                                    </div>
                                    <div className="bg-[#fff9e6] p-5 rounded-2xl border border-[#ffeeba] shadow-sm relative">
                                        <h3 className="font-bold text-[#b58b00] mb-2 text-sm uppercase">Notizen / Kundenwünsche</h3>
                                        <textarea className="w-full h-64 bg-transparent resize-none outline-none text-sm" placeholder="Allgemeine Notizen..." value={data.generalNotes} onChange={(e) => update('generalNotes', e.target.value)}></textarea>
                                    </div>
                                </div>
                            </div>

                            {/* FORM */}
                            <div className="lg:col-span-8 space-y-6">
                                <div className="lg:hidden p-4 bg-[#fff9e6] rounded-xl border border-[#ffeeba] mb-4"><textarea className="w-full h-24 bg-transparent resize-none text-sm outline-none" placeholder="Allgemeine Notizen..." value={data.generalNotes} onChange={(e) => update('generalNotes', e.target.value)} /></div>

                                {/* 1. Kundendaten */}
                                <Section id="sec-1" icon={icons.user} title="1. Kundendaten">
                                    <div className="grid grid-cols-2 gap-3">
                                        <TextInput label="Vorname" value={data.firstName} onChange={e => update('firstName', e.target.value)} width="half" />
                                        <TextInput label="Nachname" value={data.lastName} onChange={e => update('lastName', e.target.value)} width="half" />
                                    </div>
                                    <div className="mt-2 border-t pt-2">
                                        <Toggle label="Vollmacht vorhanden?" checked={data.proxyActive} onChange={e => update('proxyActive', e.target.checked)} />
                                        {data.proxyActive && <PhotoManager id="foto_vollmacht" label="Foto Vollmacht" photos={photos} setPhotos={setPhotos} />}
                                    </div>
                                </Section>

                                {/* 2. Gebäudestatus */}
                                <Section id="sec-2" icon={icons.home} title="2. Gebäudestatus">
                                    <h3 className="font-bold text-sm text-[#0071e3] uppercase mb-2">Bestandsheizung</h3>
                                    <div className="grid grid-cols-2 gap-3 mb-4">
                                        <SelectInput label="System / Heizungstyp" value={data.heatingSystem} onChange={e => update('heatingSystem', e.target.value)} options={['Ölheizung', 'Gasheizung', 'Wärmepumpe', 'Holz / Pellets', 'Fernwärme', 'Sonstiges']} width="full" />
                                        
                                        <TextInput label="Modell" value={data.heatingModel} onChange={e => update('heatingModel', e.target.value)} />
                                        <TextInput label="Baujahr" value={data.heatingYear} onChange={e => update('heatingYear', e.target.value)} width="half" />
                                        <TextInput label="Verbrauch (Liter/m³)" value={data.consumption} onChange={e => update('consumption', e.target.value)} width="half" />
                                        <TextInput label="Beheizte Fläche" value={data.heatedArea} onChange={e => update('heatedArea', e.target.value)} suffix="m²" />
                                        
                                        <MultiSelect 
                                            label="Warmwasserbereitung (Mehrfachauswahl möglich)" 
                                            selected={data.waterHeating} 
                                            onChange={val => update('waterHeating', val)} 
                                            options={['Zentral über Heizung', 'Brauchwasserwärmepumpe', 'Durchlauferhitzer', 'Boiler (Elektro)', 'Solarthermie', 'Sonstiges']} 
                                        />

                                        {data.waterHeating.includes('Sonstiges') && (
                                            <div className="col-span-2 mt-2 animate-in">
                                                <TextInput label="Bitte spezifizieren (Sonstiges)" value={data.waterHeatingOther} onChange={e => update('waterHeatingOther', e.target.value)} />
                                            </div>
                                        )}
                                    </div>

                                    {/* CONDITIONAL: Existing Tech only if Heat Pump */}
                                    {data.heatingSystem === 'Wärmepumpe' && (
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6 animate-in">
                                            <h4 className="text-xs font-bold uppercase text-blue-600 mb-3">Bestandskomponenten (da WP ausgewählt)</h4>
                                            <div className="grid grid-cols-2 gap-3">
                                                <TextInput label="Pufferspeicher Bestand" value={data.bufferTank} onChange={e => update('bufferTank', e.target.value)} />
                                                <TextInput label="Warmwasserspeicher Bestand" value={data.waterTank} onChange={e => update('waterTank', e.target.value)} />
                                                <TextInput label="Inneneinheit Bestand" value={data.indoorUnit} onChange={e => update('indoorUnit', e.target.value)} />
                                            </div>
                                        </div>
                                    )}

                                    <PhotoManager id="fotos_heizung" label="Fotos: Bestandsheizung" photos={photos} setPhotos={setPhotos} />

                                    <h3 className="font-bold text-sm text-[#0071e3] uppercase mb-2 mt-6">Wärmeverteilung</h3>
                                    <div className="grid grid-cols-2 gap-3 mb-4">
                                        <SelectInput label="Wärmeverteilung" value={data.heatDistribution} onChange={e => update('heatDistribution', e.target.value)} options={['Nur Heizkörper', 'Nur Fußbodenheizung', 'Gemischt (HK + FBH)', 'Andere']} width="full" />
                                        
                                        {data.heatDistribution === 'Andere' && (
                                            <div className="col-span-2">
                                                <TextInput label="Bitte spezifizieren" value={data.heatDistributionOther} onChange={e => update('heatDistributionOther', e.target.value)} />
                                            </div>
                                        )}

                                        <TextInput label="Anzahl Heizkreise" value={data.heatingCircuits} onChange={e => update('heatingCircuits', e.target.value)} width="half" />
                                    </div>
                                    
                                    {/* Conditional Radiator Fields */}
                                    {(data.heatDistribution.includes('Heizkörper') || data.heatDistribution === 'Andere') && (
                                        <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-4 animate-in">
                                            <div className="grid grid-cols-2 gap-3">
                                                <TextInput label="Radiatorentyp (z.B. Typ 22)" value={data.radiatorType} onChange={e => update('radiatorType', e.target.value)} />
                                                <div className="col-span-2 flex items-center pt-2">
                                                    <Toggle label="Tausch der Heizkörper nötig?" checked={data.radiatorSwap} onChange={e => update('radiatorSwap', e.target.checked)} />
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <PhotoManager id="fotos_heizkoerper" label="Fotos: Heizkörper / Verteiler" photos={photos} setPhotos={setPhotos} />
                                </Section>

                                {/* 3. Technikraum */}
                                <Section id="sec-3" icon={icons.settings} title="3. Technikraum">
                                    <div className="grid grid-cols-2 gap-3">
                                        <TextInput label="Bestandsrohrdimensionen" value={data.pipeDimensions} onChange={e => update('pipeDimensions', e.target.value)} />
                                        <TextInput label="Engste Tür (cm)" value={data.narrowestDoor} onChange={e => update('narrowestDoor', e.target.value)} suffix="cm" />
                                    </div>
                                    
                                    <div className="space-y-2 mt-4">
                                        <PhotoManager id="fotos_platzmanagement" label="Platzmanagement (Übersicht)" photos={photos} setPhotos={setPhotos} />
                                        <PhotoManager id="fotos_pumpengruppe" label="Bestehende Pumpengruppe" photos={photos} setPhotos={setPhotos} />
                                        <PhotoManager id="fotos_heizkreisverteiler" label="Heizkreisverteiler" photos={photos} setPhotos={setPhotos} />
                                        <PhotoManager id="fotos_leitungsfuehrung" label="Aktuelle Leitungsführung" photos={photos} setPhotos={setPhotos} />
                                    </div>
                                </Section>

                                {/* 4. Außeneinheit */}
                                <Section id="sec-4" icon={icons.camera} title="4. Außeneinheit">
                                    <div className="space-y-4">
                                        
                                        {/* NEW: Schallproblem Toggle */}
                                        <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                                            <Toggle label="Gibt es ein Schallproblem?" checked={data.noiseProblem} onChange={e => update('noiseProblem', e.target.checked)} />
                                            {data.noiseProblem && (
                                                <div className="mt-2 animate-in">
                                                    <TextInput label="Erklärung Schallproblem" value={data.noiseProblemNotes} onChange={e => update('noiseProblemNotes', e.target.value)} placeholder="Beschreibung..." />
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                            <Toggle label="Schutzbereich eingehalten?" checked={data.protectionZoneOK} onChange={e => update('protectionZoneOK', e.target.checked)} />
                                        </div>
                                        <PhotoManager id="fotos_aufstellort" label="Aufstellort Foto" photos={photos} setPhotos={setPhotos} />
                                        
                                        <div className="grid grid-cols-2 gap-3 pt-4 border-t">
                                            <TextInput label="Leitungsweg bis Eingang (m)" value={data.pipeLengthOuter} onChange={e => update('pipeLengthOuter', e.target.value)} suffix="m" />
                                            <PhotoManager id="fotos_leitungsweg" label="Leitungsweg Foto" photos={photos} setPhotos={setPhotos} />
                                        </div>

                                        <div className="pt-4 border-t">
                                            {/* UPDATED: 3rd Option added */}
                                            <SelectInput label="Wanddurchführung Art" value={data.wallBreakthroughType} onChange={e => update('wallBreakthroughType', e.target.value)} options={['Bestandsöffnung', 'Bohrung notwendig', 'Unterirdisch mit Wanddurchführung']} width="full" />
                                            
                                            {(data.wallBreakthroughType === 'Bohrung notwendig' || data.wallBreakthroughType === 'Unterirdisch mit Wanddurchführung') && (
                                                <div className="grid grid-cols-2 gap-3 mt-3 bg-gray-50 p-3 rounded-xl animate-in">
                                                    <TextInput label="Material" value={data.wallMaterial} onChange={e => update('wallMaterial', e.target.value)} width="half" />
                                                    <TextInput label="Wie Dick (cm)" value={data.wallThickness} onChange={e => update('wallThickness', e.target.value)} width="half" type="number" />
                                                </div>
                                            )}
                                            <PhotoManager id="fotos_wand" label="Wanddurchführung Foto" photos={photos} setPhotos={setPhotos} />
                                        </div>

                                        <div className="pt-2">
                                            <label className="text-xs text-[#86868b] mb-1 block">Besonderheiten</label>
                                            <textarea className="w-full bg-[#f5f5f7] rounded-xl p-3 text-sm h-24 outline-none border border-transparent focus:bg-white focus:border-[#0071e3]" value={data.outdoorNotes} onChange={(e) => update('outdoorNotes', e.target.value)} placeholder="Notizen zur Außenaufstellung..." />
                                        </div>
                                    </div>
                                </Section>

                                {/* 5. Elektro */}
                                <Section id="sec-5" icon={icons.zap} title="5. Elektro">
                                    <div className="grid grid-cols-2 gap-3">
                                        <TextInput label="Hauptsicherung (A)" value={data.mainFuse} onChange={e => update('mainFuse', e.target.value)} width="half" suffix="A" />
                                        <div className="col-span-2 md:col-span-1 space-y-2 pt-1">
                                            <Toggle label="Platz im Verteiler?" checked={data.elecSpace} onChange={e => update('elecSpace', e.target.checked)} />
                                            <Toggle label="Erdungsschiene frei?" checked={data.groundingRail} onChange={e => update('groundingRail', e.target.checked)} />
                                            <Toggle label="Internet verfügbar (LAN)?" checked={data.internetLan} onChange={e => update('internetLan', e.target.checked)} />
                                        </div>
                                        <TextInput label="Kabelweg (Innen zu Verteiler)" value={data.cablePathInner} onChange={e => update('cablePathInner', e.target.value)} />
                                    </div>
                                    <div className="mt-4">
                                        <label className="text-xs text-[#86868b] mb-1 block">Anmerkungsfeld Elektro</label>
                                        <textarea className="w-full bg-[#f5f5f7] rounded-xl p-3 text-sm h-20 outline-none" value={data.elecNotes} onChange={(e) => update('elecNotes', e.target.value)} />
                                    </div>
                                    <PhotoManager id="fotos_verteiler" label="Fotos Verteiler / Elektro" photos={photos} setPhotos={setPhotos} />
                                </Section>

                                {/* 6. Lieferdetails */}
                                <Section id="sec-6" icon={icons.truck} title="6. Lieferdetails">
                                    <TextInput label="Ablageort" value={data.deliveryLocation} onChange={e => update('deliveryLocation', e.target.value)} />
                                    <PhotoManager id="fotos_ablageort" label="Foto Ablageort" photos={photos} setPhotos={setPhotos} />
                                    <div className="mt-4">
                                        <label className="text-xs text-[#86868b] mb-1 block">Lieferwünsche Kunde</label>
                                        <textarea className="w-full bg-[#f5f5f7] rounded-xl p-3 text-sm h-24 outline-none" value={data.deliveryWishes} onChange={(e) => update('deliveryWishes', e.target.value)} placeholder="Besondere Wünsche..." />
                                    </div>
                                </Section>

                            </div>
                        </main>

                        <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-[#d2d2d7] p-4 z-50 no-print">
                            <div className="max-w-5xl mx-auto flex gap-3">
                                <button onClick={handleJsonExport} className="flex-1 bg-gray-100 py-3 rounded-full font-medium flex justify-center items-center gap-2"><Icon path={icons.json} size={18}/> JSON</button>
                                <button onClick={() => setView('preview')} className="flex-1 bg-[#0071e3] text-white py-3 rounded-full font-medium shadow-lg hover:shadow-xl hover:bg-[#005bb5] transition-all flex justify-center items-center gap-2">
                                    <Icon path={icons.check} size={18}/> Fertigstellen
                                </button>
                            </div>
                        </div>

                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>
